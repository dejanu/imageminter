name: Scan Images


on:
  workflow_dispatch:


jobs:
  # This workflow contains a single job called "build"
  scan:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan images with Trivy
        env:
          TRIVY_DISABLE_VEX_NOTICE: true
        run: |
          # read images in images.txt generated by script
          while IFS= read -r image; do
            echo "Scanning $image..."
            trivy image \
              --severity CRITICAL,HIGH \
              --format table \
              "$image"
              echo "âœ… Scan completed for $image"
          done < images.txt

      - name: Pull, retag and push images to ECR
        run: |
          set -euo pipefail

          ECR_REGISTRY=209202477790.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPO=alchemy-docker

           while IFS= read -r image; do
             docker pull -q --platform linux/amd64 "$image"
            
             IMAGE_NAME=$(basename "${image%%:*}")
             IMAGE_TAG="${image##*:}"
             TARGET_IMAGE="$ECR_REGISTRY/$ECR_REPO/$IMAGE_NAME:$IMAGE_TAG"
             
             docker tag "$image" "$TARGET_IMAGE"

           done < images.txt
           
           echo "Images status..."
           docker images --format '{{.Repository}}:{{.Tag}}'

  
